<div class="email-signup-component">
  <p class="email-signup-text">I'll email you when a new article drops. No spam, no fluff, just the good stuff.</p>
  <form class="email-signup-form" action="/submit.php" method="POST">
    <input 
      type="email" 
      name="email" 
      placeholder="> enter your email" 
      required 
      class="email-input"
      aria-label="Email address"
      autocomplete="email"
    >
    <button type="submit" class="email-submit-button">
      <span class="button-text">JOIN MAILING LIST</span>
    </button>
  </form>
</div>

<script>
(function() {
  'use strict';
  
  // find the form within this component (closest email-signup-component)
  const components = document.querySelectorAll('.email-signup-component');
  
  components.forEach(function(component) {
    const form = component.querySelector('.email-signup-form');
    
    if (!form) return;
    
    // skip if already initialized
    if (form.dataset.initialized === 'true') return;
    form.dataset.initialized = 'true';
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // play click sound
      if (window.playClickSound) {
        window.playClickSound();
      }
      
      const formData = new FormData(form);
      const submitButton = form.querySelector('.email-submit-button');
      const buttonText = submitButton.querySelector('.button-text');
      const originalButtonText = buttonText.textContent;
      
      // show loading state
      submitButton.disabled = true;
      submitButton.classList.remove('email-submit-button-success', 'email-submit-button-error');
      buttonText.textContent = 'Saving...';
      
      fetch('/submit.php', {
        method: 'POST',
        body: formData
      })
      .then(async response => {
        // try to parse response as JSON, even if status is not ok
        let data;
        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
          try {
            data = await response.json();
          } catch (e) {
            throw new Error('Invalid JSON response from server');
          }
        } else {
          // if not JSON, read as text to see what we got
          const text = await response.text();
          throw new Error('Server returned non-JSON response: ' + text.substring(0, 100));
        }
        
        // if response was not ok, use the error message from the server if available
        if (!response.ok) {
          throw new Error(data.message || 'Server error: ' + response.status);
        }
        
        return data;
      })
      .then(data => {
        if (data.success) {
          // show success message in button
          submitButton.classList.add('email-submit-button-success');
          submitButton.classList.remove('email-submit-button-error');
          buttonText.textContent = data.message || 'Submitted!';
          submitButton.disabled = true; // keep disabled on success
          // hide the input field
          const emailInput = form.querySelector('.email-input');
          if (emailInput) {
            emailInput.style.display = 'none';
          }
        } else {
          // show error message in button and re-enable
          submitButton.classList.add('email-submit-button-error');
          submitButton.classList.remove('email-submit-button-success');
          buttonText.textContent = data.message || 'An error occurred. Please try again.';
          submitButton.disabled = false;
          // reset after 3 seconds
          setTimeout(function() {
            buttonText.textContent = originalButtonText;
            submitButton.classList.remove('email-submit-button-error');
          }, 3000);
        }
      })
      .catch(error => {
        // show error in button and re-enable
        console.error('Email signup error:', error);
        submitButton.classList.add('email-submit-button-error');
        submitButton.classList.remove('email-submit-button-success');
        // use the error message if it's informative, otherwise show generic message
        const errorMessage = error.message && error.message.includes('Server') 
          ? error.message 
          : 'Network error. Please try again.';
        buttonText.textContent = errorMessage;
        submitButton.disabled = false;
        // reset after 3 seconds
        setTimeout(function() {
          buttonText.textContent = originalButtonText;
          submitButton.classList.remove('email-submit-button-error');
        }, 3000);
      });
    });
  });
})();
</script>

